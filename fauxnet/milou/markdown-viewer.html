<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>FAUXNET // Visionneuse Markdown</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <nav class="global-nav">
    <a href="index.html" class="brand">FAUXNET<span>.corp</span></a>
    <div class="nav-links">
      <a href="workspace.html">Espace intégral</a>
      <a href="browser.html">Navigateur</a>
      <a href="console.html">Console</a>
      <a href="terminal.html?user=invite">Terminal</a>
      <a href="markdown.html">Markdown</a>
    </div>
  </nav>

  <main class="layout-center">
    <div class="card card-large md-card">
      <header class="md-header">
        <h1>Visionneuse Markdown</h1>
        <p class="subtitle">
          Charge un fichier <code>.md</code> local ou fourni par FAUXNET.
        </p>
      </header>

      <div class="md-viewer-actions">
        <button id="mdv-open-btn">Ouvrir un fichier .md</button>
        <input
          type="file"
          id="mdv-file-input"
          accept=".md,.markdown,.txt"
          style="display:none"
        />
        <span class="small">
          Ou appelle cette page avec <code>?path=docs/ton-fichier.md</code>
          pour charger un fichier du projet.
        </span>
      </div>

      <article id="mdv-content" class="md-preview md-viewer-empty">
        <p class="muted">
          Aucun fichier chargé. Choisis un fichier ou utilise un paramètre
          <code>?path=...</code>.
        </p>
      </article>
    </div>
  </main>

  <script src="js/markdown.js"></script>
  <script>
    (function () {
      const viewer = document.getElementById("mdv-content");
      const fileInput = document.getElementById("mdv-file-input");
      const openBtn = document.getElementById("mdv-open-btn");

      if (!viewer) return;

      // Utilise le parseur commun
      const parse = window.FauxMarkdown?.parse || ((t) => t);

      async function loadFromPath(path) {
        try {
          const res = await fetch(path);
          if (!res.ok) throw new Error("HTTP " + res.status);
          const text = await res.text();
          viewer.innerHTML = parse(text);
          viewer.classList.remove("md-viewer-empty");
        } catch (e) {
          viewer.innerHTML =
            "<p class='muted'>Impossible de charger le fichier : " +
            path +
            "</p>";
        }
      }

      // Paramètre ?path=...
      const params = new URLSearchParams(window.location.search);
      const path = params.get("path");
      if (path) {
        loadFromPath(path);
      }

      // Fichier local
      openBtn.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          viewer.innerHTML = parse(text);
          viewer.classList.remove("md-viewer-empty");
        };
        reader.readAsText(file);
      });
    })();
  </script>
</body>
</html>
